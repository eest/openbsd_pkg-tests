---
  # This playbook runs some tests on the openbsd_pkg module.
  # There are some shortcomings (that I handle manually):
  # * It does not verify the results of "--check" mode.
  # * It does not actually verify the presence of packages on the managed host.
  # * The specific version of a package ties those tests to a specific version
  #   of OpenBSD (in this case 5.4).
  # * Testing "state=latest" is done by installing one version of OpenBSD with
  #   some packages, performing an upgrade via bsd.rd to the next version, and
  #   then upgrading packages from there (a virtual machine with snapshots
  #   helps a lot).
  #
  # Basic hosts-file needed:
  # [openbsd_pkg-tests]
  # 192.168.1.106 ansible_python_interpreter=/usr/local/bin/python
  #
  # Commandline:
  # ansible-playbook -i hosts -v -u root -c ssh openbsd_pkg-tests
  #
  # It is required to manually install python prior to testing this (and
  # creating the necessary symlinks).
  #
  # One way to check the result of the module is the following grep:
  # # grep pkg /var/log/messages

  - hosts: openbsd_pkg-tests
    tasks:
    - name: Reset status of bare stem package - may be changed
      action: openbsd_pkg name=nmap state=absent

    - name: Make sure bare stem package is present - should be changed
      action: openbsd_pkg name=nmap state=present
      register: result
      failed_when: result.changed == False

    - name: Make sure bare stem package is present again - should not be changed
      action: openbsd_pkg name=nmap state=present
      register: result
      failed_when: result.changed == True

    - name: Make sure bare stem package is absent - should be changed
      action: openbsd_pkg name=nmap state=absent
      register: result
      failed_when: result.changed == False

    - name: Make sure bare stem package is absent again - should not be changed
      action: openbsd_pkg name=nmap state=absent
      register: result
      failed_when: result.changed == True

    - name: Make sure bare stem package is latest - should be changed
      action: openbsd_pkg name=nmap state=latest
      register: result
      failed_when: result.changed == False

    - name: Make sure bare stem package is latest again - should not be changed
      action: openbsd_pkg name=nmap state=latest
      register: result
      failed_when: result.changed == True

    - name: Reset status of bare stem package again - should be changed
      action: openbsd_pkg name=nmap state=absent
      register: result
      failed_when: result.changed == False

    - name: Reset status of version- and flavor-less package - may be changed
      action: openbsd_pkg name=nmap-- state=absent

    - name: Make sure version- and flavor-less package is present - should be changed
      action: openbsd_pkg name=nmap-- state=present
      register: result
      failed_when: result.changed == False

    - name: Make sure verison- and flavor-less package is present again - should not be changed
      action: openbsd_pkg name=nmap-- state=present
      register: result
      failed_when: result.changed == True

    - name: Make sure version- and flavor-less  package is absent - should be changed
      action: openbsd_pkg name=nmap-- state=absent
      register: result
      failed_when: result.changed == False

    - name: Make sure version- and flavor-less package is absent again - should not be changed
      action: openbsd_pkg name=nmap-- state=absent
      register: result
      failed_when: result.changed == True

    - name: Make sure version- and flavor-less  package is latest - should be changed
      action: openbsd_pkg name=nmap-- state=latest
      register: result
      failed_when: result.changed == False

    - name: Make sure version- and flavor-less package is latest again - should not be changed
      action: openbsd_pkg name=nmap-- state=latest
      register: result
      failed_when: result.changed == True

    - name: Reset status of version- and flavor-less package again - should be changed
      action: openbsd_pkg name=nmap-- state=absent
      register: result
      failed_when: result.changed == False

    - name: Reset status of package with specific version - may be changed
      action: openbsd_pkg name=nmap-6.25p0 state=absent

    - name: Make sure package with specific verison is present - should be changed
      action: openbsd_pkg name=nmap-6.25p0 state=present
      register: result
      failed_when: result.changed == False

    - name: Make sure package with specific version is present again - should not be changed
      action: openbsd_pkg name=nmap-6.25p0 state=present
      register: result
      failed_when: result.changed == True

    - name: Make sure package with specific verison is absent - should be changed
      action: openbsd_pkg name=nmap-6.25p0 state=absent
      register: result
      failed_when: result.changed == False

    - name: Make sure package with specific version is absent again - should not be changed
      action: openbsd_pkg name=nmap-6.25p0 state=absent
      register: result
      failed_when: result.changed == True

    - name: Make sure package with specific version is latest - should be changed
      action: openbsd_pkg name=nmap-6.25p0 state=latest
      register: result
      failed_when: result.changed == False

    - name: Make sure package with specific version is latest again - should not be changed
      action: openbsd_pkg name=nmap-6.25p0 state=latest
      register: result
      failed_when: result.changed == True

    - name: Reset status of package with specific version again - should be changed
      action: openbsd_pkg name=nmap-6.25p0 state=absent
      register: result
      failed_when: result.changed == False

    - name: Reset status of version-less package - may be changed
      action: openbsd_pkg name=vim--no_x11 state=absent

    - name: Make sure version-less package is present - should be changed
      action: openbsd_pkg name=vim--no_x11 state=present
      register: result
      failed_when: result.changed == False

    - name: Make sure version-less package is present again - should not be changed
      action: openbsd_pkg name=vim--no_x11 state=present
      register: result
      failed_when: result.changed == True

    - name: Make sure version-less package is absent - should be changed
      action: openbsd_pkg name=vim--no_x11 state=absent
      register: result
      failed_when: result.changed == False

    - name: Make sure version-less package is absent again - should not be changed
      action: openbsd_pkg name=vim--no_x11 state=absent
      register: result
      failed_when: result.changed == True

    - name: Make sure version-less package is latest - should be changed
      action: openbsd_pkg name=vim--no_x11 state=latest
      register: result
      failed_when: result.changed == False

    - name: Make sure version-less package is latest again - should not be changed
      action: openbsd_pkg name=vim--no_x11 state=latest
      register: result
      failed_when: result.changed == True

    - name: Reset status of version-less package again - should be changed
      action: openbsd_pkg name=vim--no_x11 state=absent
      register: result
      failed_when: result.changed == False

    - name: Reset status of package with version and (multiple) flavors - may be changed
      action: openbsd_pkg name=mutt-1.5.21p4v0-sasl-sidebar-compressed state=absent

    - name: Make sure package with version and (multiple) flavors is present - should be changed
      action: openbsd_pkg name=mutt-1.5.21p4v0-sasl-sidebar-compressed state=present
      register: result
      failed_when: result.changed == False

    - name: Make sure package with version and (multiple) flavors is present again - should not be changed
      action: openbsd_pkg name=mutt-1.5.21p4v0-sasl-sidebar-compressed state=present
      register: result
      failed_when: result.changed == True

    - name: Make sure package with version and (multiple) flavors is absent - should be changed
      action: openbsd_pkg name=mutt-1.5.21p4v0-sasl-sidebar-compressed state=absent
      register: result
      failed_when: result.changed == False

    - name: Make sure package with version and (multiple) flavors is absent again - should not be changed
      action: openbsd_pkg name=mutt-1.5.21p4v0-sasl-sidebar-compressed state=absent
      register: result
      failed_when: result.changed == True

    - name: Make sure package with version and (multiple) flavors is latest - should be changed
      action: openbsd_pkg name=mutt-1.5.21p4v0-sasl-sidebar-compressed state=latest
      register: result
      failed_when: result.changed == False

    - name: Make sure package with version and (multiple) flavors is latest again - should not be changed
      action: openbsd_pkg name=mutt-1.5.21p4v0-sasl-sidebar-compressed state=latest
      register: result
      failed_when: result.changed == True

    - name: Reset status of package with version and (multiple) flavors again - should be changed
      action: openbsd_pkg name=mutt-1.5.21p4v0-sasl-sidebar-compressed state=absent
      register: result
      failed_when: result.changed == False
